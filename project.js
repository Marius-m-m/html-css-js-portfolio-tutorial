const projectDataPage = {
  "float": {
    title: "FLOAT",
    trailerUrl: "./assets/Trailer_Float.mp4",

    text: `
      <div class="project-meta-grid">
        <div class="meta-column">
          <h3>Project Scope</h3>
          <ul>
            <li>- 3rd Semester Project</li>
            <li>- Team of 6 People</li>
            <li>- Unreal Engine 5</li>
          </ul>
        </div>
        <div class="meta-column">
          <h3>My Role</h3>
          <ul>
            <li>- Programmer</li>
            <li>- Visual Effects</li>
            <li>- Version Control & Collaboration</li>
          </ul>
        </div>
      </div>
      <div class="project-context-section">
        <h3>FLOAT</h3>
        <p>FLOAT utilizes VR Hand Tracking for immersive puzzle gameplay to gather medical data. By wearing the Myomod bracelet during play, users generate muscle data without extra effort, directly contributing to the development of better arm prosthetics.</p>
      </div>
    `,
    images: ["./assets/project-1.1.jpg"], 

    gallery: [
      {
        src: "./assets/Walk.mp4",
        caption: "Placeholder text for Image 1. Explain what is happening in this specific screenshot or blueprint."
      },
      {
        src: "./assets/Butterfly.mp4",
        caption: "Placeholder text for Image 2. Maybe explain a specific code snippet shown above."
      },
      {
        src: "./assets/Fireworks.mp4",
        caption: "Placeholder text for Image 3. Detail regarding the level design or lighting."
      },
       {
        src: "./assets/Fish.mp4",
        caption: "Placeholder text for Image 3. Detail regarding the level design or lighting."
      }
    ],
achievements: [
      // --- MIT LINK (Werden blau/unterstrichen) ---
      {
        text: "Winner: Varjo Academic Giveaway Campaign",
        link: "https://www.linkedin.com/feed/update/urn:li:activity:7334126257871175680/"
      },
      {
        text: "Winner: Best Student Games Award | Meaningful Game",
        link: "https://www.studentgamesfestival.com/2025-winners"
      },
      {
        text: "Winner: German Multimedia Prize mb21 2025 | Main Award",
        link: "https://www.mb21.de/wettbewerbsjahr_2025.html?articles=float"
      },
      {
        text: "Nominee: XRC25 | Young Talent",
        link: "https://nextrealitycontest.de/de/nominierte/nominierte-2025/"
      },
      {
        text: "Nominee: XRC25 | Community Award",
        link: "https://nextrealitycontest.de/de/nominierte/nominierte-2025/"
      },
      {
        text: "Exhibitor: Gamescom 2025 | Business Area",
        link: "https://www.games-bavaria.com/gamescom-2025/"
      },
      {
        text: "Exhibitor: Gamescom 2025 | Entertainment Area",
        link: "https://rawtalentbooth.com/"
      },
      {
        text: "Exhibitor: GermanDevDays 2025",
        link: "https://germandevdays.com/exhibitors"
      },
      {
        text: "Exhibitor: Play! Con 2025",
        link: "https://play-con.de/ausstellerinnen-2025-neuulm/"
      },
      {
        text: "Exhibitor: Next Reality Festival 2025",
        link: "https://nextrealityfestival.com/aussteller/float/"
      },

      "Winner: HNU Werkschau | Best Game-Award",
      "Exhibitor: Hackerkiste Augsburg 2025",
      "Exhibitor: TINCON 2025",
      "Member: Meta Horizon Start Community"
    ]
  },
  "neo-tokyo": {
    title: "NEO TOKYO",
    trailerUrl: "./assets/Trailer_Neo_Tokyo.mp4",
    text: `
      <div class="project-meta-grid">
        <div class="meta-column">
          <h3>Project Scope</h3>
          <ul>
            <li>- Game Jam Project</li>
            <li>- 48 Hours</li>
            <li>- Unreal Engine 5</li>
          </ul>
        </div>
        <div class="meta-column">
          <h3>My Role</h3>
          <ul>
            <li>- Gameplay Programmer</li>
          </ul>
        </div>
      </div>
      <div class="project-context-section">
        <h3>NEO TOKYO</h3>
        <p>NEO TOKYO is an endless VR wave shooter set in a stylized cyberpunk metropolis. Players defend against increasingly difficult swarms of police drones, utilizing a strategic shop system between rounds to upgrade weapons and stats for infinite progression..</p>
      </div>
    `,
    images: ["./assets/project2.1.png"],
    
    gallery: [
      {
        src: "./assets/project2.2.mp4",
      },
    ],
achievements: [
      {
        text: "Exhibitor: Game Connect 2025 - Bayern meets Hessen ",
        link: "https://events.games-bavaria.com/event/%F0%9F%8E%AE-hessen-meets-bayern-game-connect-2025/"
      },
      {
        text: "Exhibitor: HNU Werkschau",
      },
      {
        text: "Winner: 2. HNU Game Jam",
      },
    ]
  },

  "Mercury": {
    title: "Mercury",
    trailerUrl: "./assets/Trailer_Mercury.mp4",
    
    text: `
      <div class="project-meta-grid">
        <div class="meta-column">
          <h3>Project Scope</h3>
          <ul>
            <li>- Under Development </li>
            <li>- Team of 6 People</li>
            <li>- Unreal Engine 5</li>
          </ul>
        </div>
        <div class="meta-column">
          <h3>My Role</h3>
          <ul>
            <li>- Enemy AI Behavior</li>
            <li>- Combat System Implementation</li>
            <li>- Game State Management</li>
          </ul>
        </div>
      </div>
      
      <div class="project-context-section">
        <h3>MERCURY</h3>
        <p>MERCURY is a high-octane VR Mecha Brawler designed exclusively for hand tracking. It stands as the first game of its kind, allowing players to pilot a giant mech using intuitive physical gestures. The project focuses on immersive, fast-paced close-quarters combat without the need for controllers.</p>
      </div>

      <div class="glass-card" style="padding: 1rem; margin-top: 2rem;">
          <h3 style="margin-bottom: 0.5rem;">AI Behavior Tree Logic</h3>
          
          <div id="bt-container" style="display: flex; justify-content: center; align-items: flex-start; overflow: hidden; border-radius: 12px; height: 500px; border: 1px solid rgba(255,255,255,0.2); cursor: grab; background: #1a1a1a;">
              <img id="bt-image" src="./assets/bt-full.png" alt="Unreal Engine Behavior Tree" style="max-width: 100%; height: auto; display: block; transform-origin: top center; margin-top: 20px;" />
          </div>
          
       <p class="info-box">
              Dieser Behavior Tree zeigt die komplexe Entscheidungslogik der Gegner-KI, von der Zielsuche bis zum Nahkampf-Angriff.
          </p>
    `,
    gallery: [
      {
        // WICHTIG: Ich habe /blueprint/ zu /render/ geändert, damit das Embed funktioniert!
        src: "https://blueprintue.com/render/lrxabwo3/",
        caption: "Movement Logic: Calculates velocity and blends animations.",
        isBlueprint: true 
      },
      {
        src: "https://blueprintue.com/render/435xr683/",
        caption: "Combat System: Hit detection and damage calculation.",
        isBlueprint: true
      },
      {
        src: "./assets/project-3.png",
        caption: "Resulting visual effect in-game."
      }
    ]
  }
};

function getQueryProject() {
  const params = new URLSearchParams(window.location.search);
  return params.get('project');
}

function extractYouTubeId(url) {
  const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.{11})/;
  const match = url.match(regex);
  return match ? match[1] : null;
}

function populateProjectPage(id) {
  const data = projectDataPage[id];
  const titleEl = document.getElementById('project-title');
  const trailerEl = document.getElementById('project-trailer');
  
  const imagesEl = document.querySelector('.modal-images');
  const textEl = document.querySelector('.modal-text');
  
  const galleryImagesEl = document.querySelector('.gallery-images');
  const achievementsContainer = document.querySelector('.achievements-list');
  const achievementsSection = document.getElementById('achievements-section');

  if (!data) {
    titleEl.textContent = 'Project not found';
    textEl.innerHTML = '<p>No details available for this project.</p>';
    return;
  }

// --- TITEL & TRAILER LOGIK (NEU) ---
  titleEl.textContent = data.title;
  
  // Container holen (statt dem alten iframe)
  const trailerContainer = document.getElementById('trailer-container');
  
  // Container erst leeren (falls vorher was drin war)
  if (trailerContainer) {
    trailerContainer.innerHTML = ''; 

    if (data.trailerUrl) {
      // FALL 1: Es ist eine MP4-Datei (Lokal)
      if (data.trailerUrl.endsWith('.mp4')) {
        const video = document.createElement('video');
        video.src = data.trailerUrl;
        video.controls = true; // Zeigt Play/Pause/Lautstärke
        video.autoplay = false; // Trailer nicht automatisch starten (besser für UX)
        // video.muted = true; // Falls du Autoplay willst, muss muted=true sein
        
        trailerContainer.appendChild(video);
      } 
      // FALL 2: Es ist YouTube (Fallback)
      else {
        const videoId = extractYouTubeId(data.trailerUrl);
        if (videoId) {
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${videoId}`;
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          iframe.allowFullscreen = true;
          
          trailerContainer.appendChild(iframe);
        }
      }
    }
  }

  // Bilder oben
  imagesEl.innerHTML = '';
  (data.images || []).forEach((src) => {
    const img = document.createElement('img');
    img.src = src;
    img.alt = data.title;
    imagesEl.appendChild(img);
  });
  
  textEl.innerHTML = data.text || '';

// Galerie
  galleryImagesEl.innerHTML = '';
  
  // WICHTIG: Grid-Layout NUR für 'float' aktivieren
  // Wir setzen die Klasse jedes Mal zurück, damit sie nicht bei anderen Projekten kleben bleibt
  if (id === 'float') {
    galleryImagesEl.className = 'gallery-images float-grid-mode';
  } else {
    galleryImagesEl.className = 'gallery-images'; // Standard für alle anderen
  }
  if (data.gallery && data.gallery.length > 0) {
    data.gallery.forEach(item => {
      const itemContainer = document.createElement('div');
      itemContainer.className = 'gallery-item';

      // --- NEU: VIDEO ABFRAGE START ---
      // Prüfen, ob die Datei auf .mp4 endet
      if (item.src.endsWith('.mp4')) {
        const video = document.createElement('video');
        video.src = item.src;
        
        // Einstellungen für automatischen Loop
        video.autoplay = true;
        video.loop = true;
        video.muted = true;      // Muted ist PFLICHT für Autoplay in modernen Browsern
        video.playsInline = true; // Wichtig für iOS/Mobile
        video.controls = true;   // Zeigt Play/Pause Buttons (optional, kannst du auf false setzen)
        
        itemContainer.appendChild(video);
      } 
      // --- NEU: VIDEO ABFRAGE ENDE ---

      else if (item.isBlueprint) {
        const iframeContainer = document.createElement('div');
        iframeContainer.style.cssText = `
            width: 100%; height: 500px; border-radius: 12px; overflow: hidden; 
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 30px rgba(0,0,0,0.1); background: #212121;
        `;
        const iframe = document.createElement('iframe');
        iframe.src = item.src;
        iframe.style.cssText = "width: 100%; height: 100%; border: none;";
        iframe.scrolling = "no"; 
        iframe.allowFullscreen = true;
        iframeContainer.appendChild(iframe);
        itemContainer.appendChild(iframeContainer);

      } else if (item.isZoomable) {
         const img = document.createElement('img');
         img.src = item.src;
         img.alt = "Zoomable Image";
         itemContainer.appendChild(img);
      } else {
        const img = document.createElement('img');
        img.src = item.src;
        img.alt = "Gallery Image";
        itemContainer.appendChild(img);
      }

      if (item.caption) {
        const caption = document.createElement('p');
        caption.textContent = item.caption;
        caption.style.marginTop = "1rem";
        itemContainer.appendChild(caption);
      }
      galleryImagesEl.appendChild(itemContainer);
    });
  } else {
    galleryImagesEl.innerHTML = '<p>No gallery images available.</p>';
  }

  // --- HIER WAR DER FEHLER: KORRIGIERTE ACHIEVEMENTS LOGIK ---
  if (achievementsContainer && achievementsSection) {
    achievementsContainer.innerHTML = '';
    
    if (data.achievements && data.achievements.length > 0) {
      data.achievements.forEach(ach => {
        const li = document.createElement('li');
        
        // FALL 1: Es ist ein Objekt UND hat einen Link
        if (typeof ach === 'object' && ach.link) {
            const link = document.createElement('a');
            link.href = ach.link;
            link.target = "_blank"; 
            link.textContent = ach.text;
            link.className = "achievement-link"; 
            li.appendChild(link);
        } 
        // FALL 2: Es ist ein Objekt, aber ohne Link (nur Text)
        else if (typeof ach === 'object') {
            li.textContent = ach.text;
        }
        // FALL 3: Es ist einfach nur ein Text-String (wie früher)
        else {
            li.textContent = ach;
        }
        
        achievementsContainer.appendChild(li);
      });
      achievementsSection.style.display = 'block';
    } else {
      achievementsSection.style.display = 'none';
    }
    
    if (typeof initPanzoom === 'function') {
        setTimeout(initPanzoom, 100);
    }
  }
}

// --- Zoom Logik ---
function initPanzoom() {
  const elem = document.getElementById('bt-image');
  const container = document.getElementById('bt-container');

  if (elem && container && typeof Panzoom !== 'undefined') {
      const panzoom = Panzoom(elem, {
          maxScale: 20,
          minScale: 1.0,    
          startScale: 2.0,   
          contain: 'outside',
          cursor: 'grab'
      });

      container.addEventListener('wheel', panzoom.zoomWithWheel);
      container.addEventListener('dblclick', () => {
          panzoom.reset();
      });
  }
}

// --- Tab Logik ---
function setupTabs() {
  const tabButtons = document.querySelectorAll('.modal-tabs .tab');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.tab;
      tabButtons.forEach(b => {
        const active = b === btn;
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      const panels = document.querySelectorAll('.modal-panel');
      panels.forEach(p => p.classList.toggle('hidden', p.dataset.panel !== target));
    });
  });
}

// --- Navigation Logik ---
function navigateToSection(sectionId) {
  if (window.opener && !window.opener.closed) {
    const target = sectionId ? `index.html#${sectionId}` : 'index.html';
    window.opener.location.href = target;
    window.close();
  } else {
    const target = sectionId ? `index.html#${sectionId}` : 'index.html';
    window.location.href = target;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const id = getQueryProject();
  populateProjectPage(id);
  setupTabs();
});